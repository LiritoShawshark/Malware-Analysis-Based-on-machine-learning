import os


def get_filelist(dir, list):
    for home, dirs, files in os.walk(dir):
        for filename in files:
            fullname = os.path.join(home, filename)
            list.append([filename, fullname])


if __name__ == '__main__':
    filelist = []
    get_filelist('csv/good', filelist)
    get_filelist('csv/bad', filelist)
    file_bag = []
    reg_bag = []
    for file in filelist:
        print(file[0])
        f = open(file[1], mode='r', encoding='utf-8')
        f.readline()

        while True:
            line = f.readline()
            if not line:
                break
            line = line.strip('\ufeff')
            line = line.strip('\n')
            line = line.replace('"', '')
            list = [i for i in line.split(',')]

            # list[1]为exe名，list[3]为函数名，list[4]为路径

            path_name = list[4].split('\\')

            if 'CreateFile' in list[3]:
                for i in range(len(path_name)-1):
                    if path_name[i] not in file_bag:
                        file_bag.append(path_name[i])
            elif 'RegOpenKey' in list[3]:
                for path in path_name:
                    if path not in reg_bag:
                        reg_bag.append(path)
            else:
                print('error:' + list[1] + ' ' + list[3])

        f.close()

    reg_file = open('bag/reg_bag', mode='w', encoding='utf-8')
    for reg in reg_bag:
        reg_file.write(reg + '\n')
    reg_file.close()

    file_file = open('bag/file_bag', mode='w', encoding='utf-8')
    for file in file_bag:
        file_file.write(file + '\n')
    file_file.close()
